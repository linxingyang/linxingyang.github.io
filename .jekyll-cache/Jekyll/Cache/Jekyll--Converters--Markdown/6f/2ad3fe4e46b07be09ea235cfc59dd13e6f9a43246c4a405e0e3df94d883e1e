I"œ/<h1 id="cmake">CMake</h1>

<p>CMAKEè¿™å‡ ç¯‡æ²¡æœ‰å¤ªæ·±å…¥ç ”ç©¶å®ƒçš„åŸç†ï¼Œä¸»è¦å…³æ³¨ç‚¹åœ¨ä½¿ç”¨ä¸Šã€‚</p>

<p>æ¥ç€çœ‹çœ‹Optionå’ŒIFè¿™ä¸¤ä¸ªèƒ½å¤Ÿåšçš„ä¸€äº›äº‹ã€‚</p>

<h2 id="option-å¼€å…³">OPTION å¼€å…³</h2>

<p>å®šä¹‰ä¸€ä¸ªå¼€å…³é‡ã€‚è¯­æ³•ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>option(&lt;option_variable&gt; 
  "help string describing option"
  [initial value])
</code></pre></div></div>
<ul>
  <li>option_variable å˜é‡å</li>
  <li>initial value é»˜è®¤æ˜¯OFFï¼Œå¯å–å€¼ä¸ºON æˆ–è€… OFF</li>
</ul>

<h2 id="if-æ§åˆ¶è¯­å¥">IF æ§åˆ¶è¯­å¥</h2>

<p>åŸºæœ¬ç»“æ„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF(&lt;expression&gt;)
  ...
ENDIF()
</code></pre></div></div>
<p>IF(${variable}) - å¦‚æœvariableè¢«å®šä¹‰äº†å¹¶ä¸”è¢«è®¾ç½®ä¸ºçœŸï¼Œå¦‚1, TRUE, ON, YESï¼Œé‚£ä¹ˆè¿›å…¥æ‰§è¡Œä½“</p>

<p>åœ¨ä½¿ç”¨NOTæ¥è¡¨ç¤ºç›¸åçš„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF(NOT &lt;expression&gt;)
  ...
ENDIF()
</code></pre></div></div>

<p>if-elseç»“æ„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF(&lt;expression1&gt;)
  ...
ELSEIF(&lt;expression2&gt;)
  ...
ELSE()
  ...
ENDIF()
</code></pre></div></div>

<p>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF(variable MATCHES &lt;regular expression&gt;)
  - å¦‚æœvariableè¢«å®šä¹‰äº†ï¼Œå¹¶ä¸”æ ¹æ®æ­£åˆ™èƒ½åŒ¹é…ä¸Šåé¢çš„è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆè¿›å…¥æ‰§è¡Œä½“
</code></pre></div></div>

<p>å­—ç¬¦ä¸²æ¯”è¾ƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF("${variable}" STREQUAL "foobar")
  - å¦‚æœvariableè¢«å®šä¹‰äº†ï¼Œå¹¶ä¸”äºŒè€…çš„å€¼æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆè¿›å…¥æ‰§è¡Œä½“ã€‚
  - æ³¨æ„æ­¤å¤„çš„ "${variable}"  ä½¿ç”¨åŒå¼•å·åŒ…å«ï¼Œè¿™æ„å‘³ç€${variable}å°†ä¼šè¢«è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹çš„
</code></pre></div></div>

<h3 id="if-å’Œ-option-çš„ä¾‹å­">if å’Œ option çš„ä¾‹å­</h3>

<p>æˆ‘ä»¬å¯ä»¥é…åˆä½¿ç”¨IFå’ŒOPTIONæ¥é€‰æ‹©æ€§çš„ä½¿ç”¨ä¸€äº›åº“ã€‚</p>

<p>ä¾‹å¦‚ç°åœ¨å¯ä»¥é€‰æ‹©æ”¯æŒæˆ–è€…ä¸æ”¯æŒWEBSOCKETåŠŸèƒ½ï¼Œä»¥åŠé€‰æ‹©A/BåŠŸèƒ½ä¸­çš„å…¶ä¸­ä¸€ä¸ª</p>

<p>é‚£åœ¨CMakeLists.txtä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># å®šä¸€ä¸ªå˜é‡ ENABLE_WEBSOCKET ä¸º ON
OPTION (ENABLE_WEBSOCKET
  "enable websocket"
  ON
)

# IFæ ¹æ®ENABLE_WEBSOCKETå˜é‡ä¸ºONä¸ºOFFåˆ¤æ–­èµ°å“ªä¸ªåˆ†æ”¯
IF (ENABLE_WEBSOCKET)
  MESSAGE (STATUS " current is enable websocket ")
ELSE ()
  MESSAGE (STATUS " current is disable websocket ")
ENDIF ()


# å®šä¹‰ENABLE_Aå’ŒENABLE_B
OPTION (ENABLE_A
  "enable A"
  ON
)
OPTION (ENABLE_B
  "enable B"
  OFF
)

# æ ¹æ®ENABLE_Aå’ŒENABLE_Bæ¥ç¡®å®šèµ°å“ªä¸ªåˆ†æ”¯
IF (ENABLE_A)
  MESSAGE (STATUS " current is enable A ")
ELSEIF (ENABLE_B)
  MESSAGE (STATUS " current is enable B ")
ELSE ()
  MESSAGE (STATUS " current is disable A &amp; B ")
ENDIF ()
</code></pre></div></div>

<p>åœ¨æ‰§è¡Œcmakeçš„æ—¶å€™</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test10# cd build

test10/build# cmake ..
-- The C compiler identification is GNU 5.4.0
-- The CXX compiler identification is GNU 5.4.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
--  current is enable websocket 
--  current is enable A 
-- Configuring done
-- Generating done
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºENABLE_WEBSOCKETä¸ºONï¼ŒENABLE_Aä¹Ÿä¸ºONï¼Œæ‰€ä»¥è¾“å‡ºä»¥ä¸‹ä¸¤å¥</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--  current is enable websocket 
--  current is enable A 
</code></pre></div></div>

<h4 id="optionç¼“å­˜é—®é¢˜">optionç¼“å­˜é—®é¢˜</h4>

<p>å…³äºOPTIONçš„ç¼“å­˜é—®é¢˜ï¼Œå³å½“å‰é…ç½®äº†ENABLE_WEBSOCKETä¸ºON</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPTION (ENABLE_WEBSOCKET
  "enable websocket"
  ON
)
</code></pre></div></div>

<p>ä¿®æ”¹CMakeLists.txtä¸ºOFF</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPTION (ENABLE_WEBSOCKET
  "enable websocket"
  OFF
)
</code></pre></div></div>

<p>å†ç¼–è¯‘ä¾ç„¶æ˜¾ç¤ºçš„æ˜¯enableï¼Œè€Œä¸æ˜¯disable</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test10/build# cmake ..
--  path is : /tmp/c/2019-09-12-cmaketest/dir02/
--  current is enable websocket 
--  current is enable A 
-- Configuring done
-- Generating done
-- Build files have been written to: /tmp/c/2019-09-12-cmaketest/test10/build
</code></pre></div></div>

<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è™½ç„¶ä¿®æ”¹äº†CMakeLists.txtï¼Œä½†æ˜¯CMakeCache.txtä¸­çš„ç¼“å­˜æ²¡æœ‰æ”¹å˜ï¼Œå¦‚ä¸‹æ˜¾ç¤ºåœ¨ç¼“å­˜æ–‡ä»¶ä¸­å®ƒè¿˜æ˜¯ONã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test10/build# cat CMakeCache.txt | grep ENABLE_WEBSOCKET -A 2 -B 2

//enable websocket
ENABLE_WEBSOCKET:BOOL=ON

//Value Computed by CMake
</code></pre></div></div>

<p>å¯¹äºè¿™ç§æƒ…å†µï¼Œæš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæ–¹æ³•å¯ä»¥æ›´æ–°ç¼“å­˜çš„ã€‚æš‚æ—¶çŸ¥é“ä¸¤ä¸ªæ–¹æ³•</p>
<ul>
  <li>æ‰‹åŠ¨ä¿®æ”¹CMakeCache.txtæ–‡ä»¶ï¼Œå°†å…¶ä¿®æ”¹ä¸ºOFF</li>
  <li>åˆ é™¤CMakeCache.txtæ–‡ä»¶ï¼Œå†æ¬¡è¿›è¡Œ cmake åˆ™ç”Ÿæˆæ–°çš„CmakeCache.txtä¸­ï¼Œè¯¥å€¼ä¸ºOFF</li>
</ul>

<h2 id="debugå’Œreleaseæ¨¡å¼">Debugå’ŒReleaseæ¨¡å¼</h2>

<p>æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®DEBUGï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET(CMAKE_BUILD_TYPE "Debugâ€)
</code></pre></div></div>

<p>æˆ–è€…RELEASEæ¨¡å¼ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET(CMAKE_BUILD_TYPE "Release")
</code></pre></div></div>

<p>ä¹Ÿå¯ä»¥åœ¨cmakeå‘½ä»¤åå¸¦ä¸€ä¸ªå‚æ•°æŒ‡å®šDebugè¿˜æ˜¯Releaseæ¨¡å¼</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake -DCMAKE_BUILD_TYPE="Debug" ..
</code></pre></div></div>

<h3 id="if-å’Œ-debugreleaseæ¨¡å¼">if å’Œ debug/releaseæ¨¡å¼</h3>

<p>æ­¤å¤„ä½¿ç”¨IFä»¥åŠSTREQUALæ¥åŒºåˆ†ä¸¤ç§ä¸åŒçš„ç¼–è¯‘æ–¹å¼ã€‚æ ¹æ®RELEASEå’ŒDEBUGä¸¤ç§ä¸åŒçš„ç¼–è¯‘æ–¹å¼ï¼Œå°†ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åˆ†åˆ«æ”¾åœ¨Debugå’ŒReleaseç›®å½•ä¸‹ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMAKE_MINIMUM_REQUIRED (VERSION 2.6)
PROJECT (HELLOWORLD)

# å¦‚æœæ˜¯Debugæ¨¡å¼ï¼Œé‚£ä¹ˆå°†å¯æ‰§è¡Œç¨‹åºç”Ÿæˆåˆ°buildä¸‹çš„Debugç›®å½•ä¸­
if ("${CMAKE_BUILD_TYPE}" STREQUAL "Debug") 
  MESSAGE (STATUS "current is Debug mode")
  SET (EXECUTABLE_OUTPUT_PATH /tmp/c/2019-09-12-cmaketest/test11/build/Debug)
ENDIF () 

# å¦‚æœæ˜¯Debugæ¨¡å¼ï¼Œé‚£ä¹ˆå°†å¯æ‰§è¡Œç¨‹åºç”Ÿæˆåˆ°buildä¸‹çš„Releaseç›®å½•ä¸­
if ("${CMAKE_BUILD_TYPE}" STREQUAL "Release")
  MESSAGE (STATUS "current is Release mode")
  SET (EXECUTABLE_OUTPUT_PATH /tmp/c/2019-09-12-cmaketest/test11/build/Release)
ENDIF () 

ADD_EXECUTABLE (helloworld helloworld.cpp)
</code></pre></div></div>

<p>è¿›è¡Œç¼–è¯‘</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11# cd build/
</code></pre></div></div>

<p>ä»¥Debugæ¨¡å¼ç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ° <code class="highlighter-rouge">current is Debug mode</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11/build# cmake -DCMAKE_BUILD_TYPE="Debug" ..
-- The C compiler identification is GNU 5.4.0
-- The CXX compiler identification is GNU 5.4.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- current is Debug mode
-- Configuring done
-- Generating done
-- Build files have been written to: /tmp/c/2019-09-12-cmaketest/test11/build
</code></pre></div></div>

<p>åŒæ—¶å¯æ‰§è¡Œç¨‹åºhelloworldè¢«æ”¾åˆ° Debug ç›®å½•ä¸‹äº†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11/build# make
Scanning dependencies of target helloworld
[ 50%] Building CXX object CMakeFiles/helloworld.dir/helloworld.cpp.o
[100%] Linking CXX executable Debug/helloworld
[100%] Built target helloworld
</code></pre></div></div>

<p>ä»¥Releaseæ¨¡å¼ç¼–è¯‘ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11/build# cmake -DCMAKE_BUILD_TYPE="Release" ..     
-- current is Release mode
-- Configuring done
-- Generating done
-- Build files have been written to: /tmp/c/2019-09-12-cmaketest/test11/build
</code></pre></div></div>

<p>å¯æ‰§è¡Œç¨‹åºæ”¾åˆ°Releaseç›®å½•ä¸‹äº†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11/build# make
[ 50%] Building CXX object CMakeFiles/helloworld.dir/helloworld.cpp.o
[100%] Linking CXX executable Release/helloworld
[100%] Built target helloworld
</code></pre></div></div>

<p>å½“å‰buildä¸‹çš„ç›®å½•æƒ…å†µã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test11/build# tree -F -L 2 -I CMakeFiles
.
â”œâ”€â”€ CMakeCache.txt
â”œâ”€â”€ cmake_install.cmake
â”œâ”€â”€ Debug/
â”‚Â Â  â””â”€â”€ helloworld*
â”œâ”€â”€ Makefile
â””â”€â”€ Release/
    â””â”€â”€ helloworld*
</code></pre></div></div>

<h2 id="äº¤å‰ç¼–è¯‘">äº¤å‰ç¼–è¯‘</h2>

<p>å†™åµŒå…¥å¼ç¨‹åºçš„æ—¶å€™å…ä¸äº†è¦äº¤å‰ç¼–è¯‘ï¼Œåœ¨CMakeLists.txtä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ç¼–è¯‘ç›®æ ‡ä¸ºNUVOTON
OPTION (COMPILER_FOR_NUVOTON
  " compile chain for nuvoton "
  ON
)

# ç¼–è¯‘ç›®æ ‡ä¸ºARAGO
OPTION (COMPILER_FOR_ARAGO
  " compile chain for arago "
  OFF
)

# æ ¹æ®å¯¹åº”çš„ç¼–è¯‘æ–¹å¼ï¼ŒæŒ‡å®šC/C++ç¼–è¯‘å™¨(CMAKE_C_COMPILER,CMAKE_CXX_COMPILER)ã€ä¾èµ–åº“ç›®å½•(LINK_DIRECTORIES)ã€å¤´æ–‡ä»¶ç›®å½•(INCLUDE_DIRECTORIES)ã€‚
IF (COMPILER_FOR_NUVOTON)
  MESSAGE (STATUS " use nuvoton compile chain ")
  SET(CMAKE_C_COMPILER "/opt/vbox/arm_linux_4.8/bin/arm-nuvoton-linux-uclibceabi-gcc")
  SET(CMAKE_CXX_COMPILER "/opt/vbox/arm_linux_4.8/bin/arm-nuvoton-linux-uclibceabi-g++")
  INCLUDE_DIRECTORIES(/opt/vbox/arm_linux_4.8/include)
  LINK_DIRECTORIES(/opt/vbox/arm_linux_4.8/lib)

ELSEIF (COMPILER_FOR_ARAGO)
  MESSAGE (STATUS " use arago compile chain ")
  SET(CMAKE_C_COMPILER "/opt/vbox/arago-linux-devkit/bin/arm-arago-linux-gnueabi-gcc")
  SET(CMAKE_CXX_COMPILER "/opt/vbox/arago-linux-devkit/bin/arm-arago-linux-gnueabi-g++")
  INCLUDE_DIRECTORIES(/opt/x86/24-xfrp/working/bin/libevent/arago/include)
  LINK_DIRECTORIES(/opt/x86/24-xfrp/working/bin/libevent/arago/lib)

ELSE ()
  MESSAGE (STATUS " use default compile chain ")

ENDIF ()
</code></pre></div></div>

<h2 id="åŒºåˆ†ä¸åŒçš„æ“ä½œç³»ç»Ÿ">åŒºåˆ†ä¸åŒçš„æ“ä½œç³»ç»Ÿ</h2>

<p>åŒºåˆ†windowsã€unixç³»åˆ—ã€è‹¹æœç³»ç»Ÿã€‚ä½¿ç”¨CMAKEå†…ç½®çš„å‡ ä¸ªå˜é‡æ¥åŒºåˆ†ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF (WIN32)
  MESSAGE(STATUS "current is windows.")
ELSEIF (APPLE)
  MESSAGE(STATUS "current is Apple systens.")
ELSEIF (UNIX)
  MESSAGE(STATUS "current is UNIX-like OS's.")
ENDIF ()
</code></pre></div></div>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<ul>
  <li>cmake practice</li>
  <li><a href="https://www.cnblogs.com/liu3yuan/p/6895419.html">ä¸ºä½•è¦ä½¿ç”¨cmakeä¸­æ–‡ç¿»è¯‘å‚è€ƒ</a></li>
  <li><a href="https://cmake.org/cmake/help/latest/manual/cmake-variables.7.html#variables-that-change-behavior">cmakeå˜é‡</a></li>
</ul>
:ET